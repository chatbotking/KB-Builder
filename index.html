<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Knowledge Base Builder</title>
    <!-- Import Montserrat Font -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Global Styles */
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
            border-radius: 10px;
            background: #ffffff;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* Headings */
        h1, h2 {
            color: #000000;
            text-align: center;
            margin-bottom: 25px;
            font-weight: 600;
        }

        /* Instructions Section */
        .instructions {
            margin: 25px 0;
            padding: 20px;
            background: #e7f8f5;
            border-left: 5px solid #36D6B5;
            border-radius: 5px;
            font-size: 16px;
        }

        .instructions h3 {
            margin-top: 0;
            color: #36D6B5;
        }

        .instructions ul {
            padding-left: 25px;
        }

        /* Form Inputs and Buttons */
        input, button, textarea {
            padding: 14px;
            margin: 12px 0;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 100%;
            box-sizing: border-box;
            transition: border 0.3s, box-shadow 0.3s;
        }

        input:focus, textarea:focus {
            border-color: #36D6B5;
            box-shadow: 0 0 5px rgba(54, 214, 181, 0.5);
            outline: none;
        }

        button {
            background: #36D6B5;
            color: #fff;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        button:hover {
            background: #2cb399;
        }

        /* Loading and Error Messages */
        #loading, #error {
            display: none;
            text-align: center;
            margin: 25px 0;
            font-size: 16px;
        }

        #loading .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #36D6B5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Links List */
        #linksList {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 450px;
            overflow-y: auto;
        }

        #linksList li {
            margin: 12px 0;
            padding: 12px;
            background: #f1f1f1;
            border-radius: 5px;
            transition: background 0.3s;
        }

        #linksList li:hover {
            background: #e0f7f5;
        }

        /* Page Sections */
        .page-section {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
            position: relative;
            transition: background 0.3s;
        }

        .page-section:hover {
            background: #f1f1f1;
        }

        .page-section p {
            max-height: 450px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            background: #ffffff;
        }

        /* Enhance and Combine Buttons */
        .enhance-button, .combine-button {
            margin-top: 20px;
            background: #36D6B5;
            color: #fff;
            cursor: pointer;
            padding: 14px 22px;
            border: none;
            border-radius: 5px;
            width: 48%;
            font-weight: 600;
            transition: background 0.3s;
        }

        .enhance-button:hover, .combine-button:hover {
            background: #2cb399;
        }

        /* Progress Bar */
        #progress {
            display: none;
            text-align: center;
            margin: 25px 0;
        }

        #progressBar {
            width: 0%;
            height: 25px;
            background: #36D6B5;
            border-radius: 5px;
            transition: width 0.3s;
        }

        #progressText {
            margin-top: 10px;
            font-size: 16px;
            color: #333;
        }

        /* Final Prompt Section */
        #finalPrompt {
            margin-top: 30px;
            position: relative;
        }

        #finalPrompt h2 {
            margin-bottom: 15px;
        }

        #finalPromptText {
            resize: vertical;
            height: 150px;
            background: #f9f9f9;
        }

        /* Toggle and Save Buttons */
        .final-prompt-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .final-prompt-controls button {
            width: 48%;
        }

        .final-prompt-controls .toggle-links {
            display: flex;
            align-items: center;
            margin-top: 10px;
            width: 100%;
        }

        .final-prompt-controls .toggle-links input {
            margin-right: 10px;
            width: auto;
        }

        /* Playground Section */
        #playground {
            margin-top: 50px;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 25px;
            background: #ffffff;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        #playground h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #000000;
        }

        #systemPrompt {
            width: 100%;
            padding: 14px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: vertical;
            font-family: 'Montserrat', sans-serif;
        }

        /* Clear Links Button */
        #clearLinksButton {
            background-color: #ff4d4d;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: 600;
            transition: background 0.3s;
            margin-top: 10px;
        }

        #clearLinksButton:hover {
            background-color: #ff1a1a;
        }

        /* Clear Chat Functionality */
        #clearChat {
            background-color: #ff4d4d;
            margin-top: 10px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: 600;
            padding: 10px 0;
            cursor: pointer;
            transition: background 0.3s;
        }

        #clearChat:hover {
            background-color: #ff1a1a;
        }

        /* Conversation Messages */
        #conversation {
            height: 450px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            position: relative;
        }

        .user-message {
            background-color: #e6f3ff;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 12px;
            max-width: 80%;
        }

        .bot-message {
            background-color: #f0f0f0;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 12px;
            max-width: 80%;
            position: relative;
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
        }

        .bot-message.error {
            background-color: #ffe6e6;
            color: #cc0000;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 12px;
        }

        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            background-color: #333;
            border-radius: 50%;
            animation: blink 1.4s infinite both;
        }

        .typing-indicator .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }

        #userInput {
            width: 100%;
            padding: 14px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: vertical;
            font-family: 'Montserrat', sans-serif;
        }

        #sendMessage {
            background-color: #36D6B5;
            color: white;
            border: none;
            padding: 14px 25px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: 600;
            transition: background 0.3s;
            width: 100%;
        }

        #sendMessage:hover {
            background-color: #2cb399;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            #controls label {
                width: 100%;
            }

            .final-prompt-controls button {
                width: 100%;
                margin-bottom: 10px;
            }

            .final-prompt-controls .toggle-links {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chatbot Knowledge Base Builder</h1>
        
        <div class="instructions">
            <h3>Create powerful prompts with Chatbot Builder AI’s Knowledge Base Builder:</h3>
            <ul>
                <li>1. Configure your bot.</li>
                <li>2. Enter the website to extract text from.</li>
                <li>3. Select pages from the generated links.</li>
                <li>4. Add or enhance text for your final prompt.</li>
                <li>5. Copy and paste the prompt into the playground for testing, or your desired final location.</li>
                <li>6. <strong>IMPORTANT</strong>: Save your final prompt in the desired location: Default Agent, Default Flow, or in an Assistant.</li>
            </ul>
        </div>

        <h2>Site Page Links Extractor</h2>
        
        <h3>Chatbot Configuration</h3>
        <input type="text" id="businessName" placeholder="Business Name">
        <textarea id="businessDetails" placeholder="Business Contact Details"></textarea>
        <input type="text" id="toneOfVoice" placeholder="Tone of Voice">
        <input type="number" id="desiredLength" placeholder="Target Line Count for Responses">

        <input type="text" id="domain" placeholder="Enter domain (e.g., example.com or https://example.com)">
        <button onclick="fetchSiteLinks()">Get Links</button>
        <button id="clearLinksButton" onclick="clearLinks()" style="display:none;">Clear Links</button>
        <p id="loading"><span class="spinner"></span></p>
        <p id="error" style="color: red;"></p>
        <div id="linksContainer">
            <button id="selectAllButton" onclick="toggleSelectAll()" style="display:none; margin-bottom: 15px;">Select All</button>
            <ul id="linksList"></ul>
        </div>
        <button id="extractButton" style="display:none;" onclick="extractSelectedContent()">Extract Selected Content</button>
        <div id="progress">
            <div id="progressBar"></div>
            <p id="progressText"></p>
        </div>
    
        <div id="textContent"></div>
    
        <div id="finalPrompt">
            <h2>Final Prompt</h2>
            <textarea id="finalPromptText" rows="10" readonly></textarea>
            <div class="final-prompt-controls">
                <button class="enhance-button" onclick="enhanceFinalPrompt()">Enhance Final Prompt</button>
                <button onclick="copyFinalPrompt()" style="margin-top: 10px;">Copy Final Prompt</button>
                <button onclick="saveFinalPrompt()" style="margin-top: 10px;">Save Final Prompt</button>
                <button onclick="clearFinalPrompt()" style="margin-top: 10px;">Clear Final Prompt</button>
            </div>
            <div class="final-prompt-controls">
                <div class="toggle-links">
                    <input type="checkbox" id="toggleLinks" onchange="toggleLinksInFinalPrompt()">
                    <label for="toggleLinks">Include Selected Links in Final Prompt</label>
                </div>
            </div>
        </div>
    </div>

    <div id="playground" class="container">
        <h2>Chatbot Playground</h2>
        <textarea id="systemPrompt" rows="5" placeholder="Paste your final prompt here. This will act as system instructions."></textarea>
        <div id="controls">
            <label>
                Temperature:
                <input type="number" id="temperature" min="0" max="1" step="0.1" value="0.7">
            </label>
            <label>
                Max Tokens:
                <input type="number" id="maxTokens" min="1" max="2048" value="150">
            </label>
        </div>
        <div id="conversation"></div>
        <textarea id="userInput" rows="3" placeholder="Type your message here..."></textarea>
        <button id="sendMessage">Send</button>
        <button id="clearChat" onclick="clearChat()">Clear Chat</button>
    </div>

    <script>
        // Services
        const scrapingBeeApiKey = 'MWTR8ILYZSF7CW99AJ3RL8942ULLACY6ARXACDQKWQP6HGNT3YE6EH25171MLBP7DODJ6FZGWQ535WXL';
        const openAiApiKey = 'sk-6ttKsUFfnBX0GNP2LJ7ninmHsYqlkr4O6Ot0c8um2UT3BlbkFJyhoZ2GqjeWFPWAdAbFWYNLiFESLLokTLcKQThWgpYA';
        const scraperApiKey = '26e6e8745c8d965d9cb28eb754d72b6e';

        let mainPromptContent = '';
        let linksContent = '';
        let linksIncluded = false;

        // Load saved data from localStorage on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadFinalPrompt();
            loadConfiguration();
            loadToggleState();
            loadLinksSelection();
            loadPlaygroundConversation();
            setupPlaygroundEventListeners();
        });

        // Ensure the URL has HTTPS
        function ensureHttps(url) {
            return url.trim().startsWith('http') ? url.trim() : 'https://' + url.trim();
        }

        // Fetch content using ScrapingBee API
        async function fetchWithScrapingBee(url) {
            try {
                const response = await fetch(`https://app.scrapingbee.com/api/v1/?api_key=${scrapingBeeApiKey}&url=${encodeURIComponent(url)}&render_js=false`);
                if (!response.ok) throw new Error(`Failed to fetch ${url} with ScrapingBee. Status: ${response.status}`);
                return await response.text();
            } catch (error) {
                console.error('Fetch error with ScrapingBee:', error);
                throw error;
            }
        }

        // Fetch content using ScraperAPI
        async function fetchWithScraperApi(url) {
            try {
                const response = await fetch(`https://api.scraperapi.com/?api_key=${scraperApiKey}&url=${encodeURIComponent(url)}`);
                if (!response.ok) throw new Error(`Failed to fetch ${url} with ScraperAPI. Status: ${response.status}`);
                return await response.text();
            } catch (error) {
                console.error('Fetch error with ScraperAPI:', error);
                throw error;
            }
        }

        // Fetch site links from sitemap.xml
        async function fetchSiteLinks() {
            const domainInput = document.getElementById('domain');
            const domain = ensureHttps(domainInput.value);
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const linksList = document.getElementById('linksList');
            const extractButton = document.getElementById('extractButton');
            const selectAllButton = document.getElementById('selectAllButton');
            const clearLinksButton = document.getElementById('clearLinksButton');

            loading.style.display = 'block';
            error.style.display = 'none';
            linksList.innerHTML = '';
            extractButton.style.display = 'none';
            selectAllButton.style.display = 'none';
            clearLinksButton.style.display = 'none';

            try {
                let content;
                try {
                    const sitemapUrl = `${domain}/sitemap.xml`;
                    content = await fetchWithScrapingBee(sitemapUrl);
                    const urls = await parseSitemaps(content);

                    if (urls.length === 0) throw new Error('No URLs found in the sitemap.');

                    urls.forEach(url => {
                        const li = document.createElement('li');
                        li.innerHTML = `<label><input type="checkbox" value="${url}" onchange="updateLinksContent()"> <span>${url}</span></label>`;
                        linksList.appendChild(li);
                    });

                    extractButton.style.display = 'block';
                    selectAllButton.style.display = 'inline-block';
                    clearLinksButton.style.display = 'inline-block';

                    // Save the links list to localStorage
                    saveLinksList(urls);
                } catch (scrapingBeeError) {
                    console.error('ScrapingBee failed, using ScraperAPI for direct text extraction:', scrapingBeeError);
                    content = await fetchWithScraperApi(domain);
                    const text = extractTextFromHtml(content, domain);
                    const pageSection = document.createElement('div');
                    pageSection.className = 'page-section';
                    pageSection.innerHTML = `
                        <h3>${domain}</h3>
                        <p>${text}</p>
                        <button class="enhance-button" onclick="enhanceText(this)">Enhance</button>
                        <button class="combine-button" onclick="addToFinalPrompt(this)">Add to Final Prompt</button>
                    `;
                    document.getElementById('textContent').appendChild(pageSection);
                    updateMainPromptContent();
                }
            } catch (err) {
                console.error('Error:', err);
                error.textContent = `Error: ${err.message}`;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        // Parse sitemap XML and extract URLs
        async function parseSitemaps(sitemapContent) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(sitemapContent, 'text/xml');
            const urls = [];

            const sitemapNodes = xmlDoc.getElementsByTagName('sitemap');
            if (sitemapNodes.length > 0) {
                for (let i = 0; i < sitemapNodes.length; i++) {
                    const sitemapLoc = sitemapNodes[i].getElementsByTagName('loc')[0].textContent.trim();
                    const subSitemapContent = await fetchWithScrapingBee(sitemapLoc);
                    const subUrls = await parseSitemaps(subSitemapContent);
                    urls.push(...subUrls);
                }
            } else {
                const locNodes = xmlDoc.getElementsByTagName('loc');
                for (let i = 0; i < locNodes.length; i++) {
                    urls.push(locNodes[i].textContent.trim());
                }
            }
            return urls;
        }

        // Toggle select/deselect all checkboxes
        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('#linksList input[type="checkbox"]');
            const selectAllButton = document.getElementById('selectAllButton');
            const isSelectAll = selectAllButton.textContent === 'Select All';
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = isSelectAll;
            });
            
            selectAllButton.textContent = isSelectAll ? 'Deselect All' : 'Select All';
            updateLinksContent();
        }

        // Extract selected content from URLs
        async function extractSelectedContent() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const textContent = document.getElementById('textContent');
            const progress = document.getElementById('progress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const selectedUrls = Array.from(document.querySelectorAll('#linksList input[type="checkbox"]:checked')).map(cb => cb.value);

            if (selectedUrls.length === 0) {
                alert('Please select at least one link to extract content from.');
                return;
            }

            loading.style.display = 'block';
            error.style.display = 'none';
            textContent.innerHTML = '';
            progress.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = 'Starting extraction...';

            try {
                for (let i = 0; i < selectedUrls.length; i++) {
                    const url = selectedUrls[i];
                    const content = await fetchWithScrapingBee(url);
                    const originalDomain = new URL(url).origin;
                    const text = extractTextFromHtml(content, originalDomain);
                    const pageSection = document.createElement('div');
                    pageSection.className = 'page-section';
                    pageSection.innerHTML = `
                        <h3>${url}</h3>
                        <p>${text}</p>
                        <button class="enhance-button" onclick="enhanceText(this)">Enhance</button>
                        <button class="combine-button" onclick="addToFinalPrompt(this)">Add to Final Prompt</button>
                    `;
                    textContent.appendChild(pageSection);

                    const progressPercent = ((i + 1) / selectedUrls.length) * 100;
                    progressBar.style.width = `${progressPercent}%`;
                    progressText.textContent = `Processing ${i + 1} of ${selectedUrls.length}`;
                }
                updateMainPromptContent();
                progressText.textContent = 'Extraction complete!';
            } catch (err) {
                console.error('Error:', err);
                error.textContent = `Error: ${err.message}`;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                // Optionally hide progress after some time
                setTimeout(() => { progress.style.display = 'none'; }, 2000);
            }
        }

        // Extract and clean text from HTML content
        function extractTextFromHtml(html, originalDomain) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Remove unwanted tags
            ['script', 'style', 'noscript', 'meta', 'link', 'header', 'nav', 'aside'].forEach(tag => {
                doc.querySelectorAll(tag).forEach(el => el.remove());
            });

            const content = doc.body.cloneNode(true);
            
            // Convert relative URLs to absolute
            content.querySelectorAll('a').forEach(link => {
                const href = link.getAttribute('href');
                if (href) {
                    try {
                        const absoluteUrl = new URL(href, originalDomain).href;
                        link.textContent = absoluteUrl;
                        link.setAttribute('href', absoluteUrl);
                    } catch (e) {
                        console.warn(`Invalid URL encountered: ${href}`);
                        link.textContent = href;
                    }
                }
            });

            content.querySelectorAll('img, video').forEach(el => {
                const src = el.getAttribute('src');
                if (src) {
                    try {
                        const absoluteUrl = new URL(src, originalDomain).href;
                        el.setAttribute('src', absoluteUrl);
                    } catch (e) {
                        console.warn(`Invalid src encountered: ${src}`);
                        el.setAttribute('src', src);
                    }
                }
            });

            // Remove all HTML tags and clean text
            const text = content.innerHTML.replace(/<a\s+(?:[^>]*?\s+)?href="([^"]*)"[^>]*>(.*?)<\/a>/g, '$1');
            const cleanText = text.replace(/<[^>]*>/g, ' ')
                                  .replace(/&nbsp;/g, ' ')
                                  .replace(/\s+/g, ' ')
                                  .trim();

            return cleanText;
        }

        // Enhance extracted text using OpenAI API
        async function enhanceText(button) {
            const section = button.parentNode;
            const url = section.querySelector('h3').textContent;
            const text = section.querySelector('p').textContent;
            button.disabled = true;
            button.textContent = 'Enhancing...';

            const messages = [
                {
                    role: "system",
                    content: "You are an AI assistant optimizing content for a chatbot knowledge base for your website. Enhance and optimize the following content to make it detailed, structured, and suitable for use in a chatbot. Only if the actual information and data is present, collect useful information such as contact details (phone numbers, email addresses, physical addresses), organized links to webpages, images, videos, and downloadable files, along with page-specific content like titles, headings, body text, product descriptions, FAQs, and blog posts. Include media assets such as images and videos with metadata, descriptive meta information like page titles and alt text, and structured data relevant to SEO. Exclude unnecessary elements such as header/footer symbols, placeholder text, navigation metadata like breadcrumbs and pagination, cart statuses, advertisements, promotional banners, affiliate links, cookie banners, session-specific information, tracking tags, interactive UI elements without meaningful text, error messages, and duplicate content like repeated headers or links. Ensure the collected data is extremely accurate logically grouped, filtered for duplicates, and aligned with the knowledge base’s goals. Do not use markdown or things ### or * in your response for formatting or any other purpose. Keep things well organized and ONLY use plain text. Start of output with something like “You are the assistant for…..and your goal is to… and ensure you are highly accurate and detailed but not redundant. Never use placeholders, if data isn’t present just don’t mention it"
                },
                {
                    role: "user",
                    content: `Content to enhance:\n\n${text}\n\nOptimized content:`
                }
            ];

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openAiApiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini", // Correct OpenAI model name
                        messages: messages,
                        max_tokens: 2500,
                        temperature: 0.7,
                        top_p: 1,
                        frequency_penalty: 0,
                        presence_penalty: 0
                    })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Unauthorized: Please check your OpenAI API key.');
                    } else {
                        throw new Error(`Failed to enhance text. Status: ${response.status}`);
                    }
                }

                const result = await response.json();
                section.querySelector('p').textContent = result.choices[0].message.content.trim();
                button.textContent = 'Enhanced';
                updateMainPromptContent();
                alert('Text enhanced successfully!');
            } catch (error) {
                console.error('Error enhancing text:', error);
                alert('Error enhancing text: ' + error.message);
                button.textContent = 'Enhance';
            } finally {
                button.disabled = false;
            }
        }

        // Add enhanced text to final prompt
        function addToFinalPrompt(button) {
            const section = button.parentNode;
            const url = section.querySelector('h3').textContent;
            const text = section.querySelector('p').textContent;

            mainPromptContent += `\n\n${url}\n${text}`;

            button.textContent = 'Added to Final Prompt';
            button.disabled = true;
            updateMainPromptContent();
            alert('Added to Final Prompt successfully!');
        }

        // Update the final prompt textarea and save to localStorage
        function updateMainPromptContent() {
            const finalPromptText = document.getElementById('finalPromptText');
            const businessName = document.getElementById('businessName').value;
            const businessDetails = document.getElementById('businessDetails').value;
            const toneOfVoice = document.getElementById('toneOfVoice').value;
            const desiredLength = document.getElementById('desiredLength').value;

            let configText = 'Chatbot Configuration:\n';
            if (businessName) configText += `Business Name: ${businessName}\n`;
            if (businessDetails) configText += `Business Details: ${businessDetails}\n`;
            if (toneOfVoice) configText += `Tone of Voice: ${toneOfVoice}\n`;
            if (desiredLength) configText += `Target Line Count for Responses: ${desiredLength}\n`;

            // Reconstruct the main prompt content without links
            let updatedContent = `${configText}\n${mainPromptContent}`.trim();

            // If links are included, append them
            if (linksIncluded) {
                updatedContent += `\n\nSelected Links:\n${linksContent}`.trim();
            }

            finalPromptText.value = updatedContent;

            // Save to localStorage
            saveFinalPromptToLocal();
        }

        // Handle toggle for including links in final prompt
        function toggleLinksInFinalPrompt() {
            const toggle = document.getElementById('toggleLinks');
            linksIncluded = toggle.checked;
            updateMainPromptContent();
            saveToggleState();
        }

        // Update links content based on selected checkboxes
        function updateLinksContent() {
            const selectedLinks = Array.from(document.querySelectorAll('#linksList input[type="checkbox"]:checked')).map(cb => cb.value);
            linksContent = selectedLinks.join('\n');
            updateMainPromptContent();
        }

        // Save final prompt to localStorage
        function saveFinalPromptToLocal() {
            const finalPromptText = document.getElementById('finalPromptText').value;
            localStorage.setItem('finalPromptText', finalPromptText);
            localStorage.setItem('mainPromptContent', mainPromptContent);
            localStorage.setItem('linksContent', linksContent);
            localStorage.setItem('linksIncluded', linksIncluded);
        }

        // Load final prompt from localStorage
        function loadFinalPrompt() {
            const savedFinalPrompt = localStorage.getItem('finalPromptText');
            const savedMainPromptContent = localStorage.getItem('mainPromptContent');
            const savedLinksContent = localStorage.getItem('linksContent');
            const savedLinksIncluded = localStorage.getItem('linksIncluded') === 'true';

            if (savedFinalPrompt) {
                document.getElementById('finalPromptText').value = savedFinalPrompt;
                mainPromptContent = savedMainPromptContent || '';
                linksContent = savedLinksContent || '';
                linksIncluded = savedLinksIncluded;
            }
        }

        // Save links list to localStorage
        function saveLinksList(urls) {
            localStorage.setItem('linksList', JSON.stringify(urls));
        }

        // Load links selection from localStorage
        function loadLinksSelection() {
            const savedLinksList = JSON.parse(localStorage.getItem('linksList')) || [];
            const linksList = document.getElementById('linksList');
            const clearLinksButton = document.getElementById('clearLinksButton');

            // If links are already present, skip loading
            if (linksList.children.length > 0) return;

            savedLinksList.forEach(url => {
                const li = document.createElement('li');
                li.innerHTML = `<label><input type="checkbox" value="${url}" onchange="updateLinksContent()"> <span>${url}</span></label>`;
                linksList.appendChild(li);
            });

            if (savedLinksList.length > 0) {
                document.getElementById('extractButton').style.display = 'block';
                document.getElementById('selectAllButton').style.display = 'inline-block';
                clearLinksButton.style.display = 'inline-block';
            }
        }

        // Save toggle state to localStorage
        function saveToggleState() {
            localStorage.setItem('linksIncluded', linksIncluded);
        }

        // Load toggle state from localStorage
        function loadToggleState() {
            const savedLinksIncluded = localStorage.getItem('linksIncluded') === 'true';
            linksIncluded = savedLinksIncluded;
            document.getElementById('toggleLinks').checked = linksIncluded;
        }

        // Save Final Prompt as a text file
        function saveFinalPrompt() {
            const finalPromptText = document.getElementById('finalPromptText').value;
            const blob = new Blob([finalPromptText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'final_prompt.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Final prompt saved to your device!');
        }

        // Enhance Final Prompt using OpenAI API
        async function enhanceFinalPrompt() {
            const finalPromptText = document.getElementById('finalPromptText');
            const enhanceButton = document.querySelector('#finalPrompt .enhance-button');
            const text = finalPromptText.value;
            enhanceButton.disabled = true;
            enhanceButton.textContent = 'Enhancing...';

            const messages = [
                {
                    role: "system",
                    content: "You are an AI assistant optimizing content for a chatbot knowledge base. Enhance and optimize the following content to make it detailed, structured, and suitable for use in a chatbot. Ensure the text is clear, informative, and well-organized Collect useful information such as contact details (phone numbers, email addresses, physical addresses), organized links to webpages, images, videos, and downloadable files, along with page-specific content like titles, headings, body text, product descriptions, FAQs, and blog posts. Include media assets such as images and videos with metadata, descriptive meta information like page titles and alt text, and structured data relevant to SEO. Exclude unnecessary elements such as header/footer symbols, placeholder text, navigation metadata like breadcrumbs and pagination, cart statuses, advertisements, promotional banners, affiliate links, cookie banners, session-specific information, tracking tags, interactive UI elements without meaningful text, error messages, and duplicate content like repeated headers or links. Ensure the collected data is extremely accurate, logically grouped, filtered for duplicates, and aligned with the knowledge base’s goals. Do not use ### or * in your response for formatting or any other purpose. Keep things well organized and ONLY use plain text. Start of output with something like “You are the assistant for…..and your goal is to… and ensure you are highly accurate and detailed but not redundant. Also"
                },
                {
                    role: "user",
                    content: `Content to enhance:\n\n${text}\n\nOptimized:`
                }
            ];

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openAiApiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini", // Correct OpenAI model name
                        messages: messages,
                        max_tokens: 2500,
                        temperature: 0.7,
                        top_p: 1,
                        frequency_penalty: 0,
                        presence_penalty: 0
                    })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Unauthorized: Please check your OpenAI API key.');
                    } else {
                        throw new Error(`Failed to enhance final prompt. Status: ${response.status}`);
                    }
                }

                const result = await response.json();
                finalPromptText.value = result.choices[0].message.content.trim();
                enhanceButton.textContent = 'Enhanced';
                updateMainPromptContent();
                alert('Final Prompt enhanced successfully!');
            } catch (error) {
                console.error('Error enhancing final prompt:', error);
                alert('Error enhancing final prompt: ' + error.message);
                enhanceButton.textContent = 'Enhance Final Prompt';
            } finally {
                enhanceButton.disabled = false;
            }
        }

        // Copy Final Prompt to Clipboard
        function copyFinalPrompt() {
            const finalPromptText = document.getElementById('finalPromptText');
            finalPromptText.select();
            finalPromptText.setSelectionRange(0, 99999); // For mobile devices
            document.execCommand('copy');
            alert('Final prompt copied to clipboard!');
        }

        // Clear Configuration Area
        function clearConfiguration() {
            if (!confirm('Are you sure you want to clear the Configuration Area?')) return;

            document.getElementById('businessName').value = '';
            document.getElementById('businessDetails').value = '';
            document.getElementById('toneOfVoice').value = '';
            document.getElementById('desiredLength').value = '';
            document.getElementById('domain').value = '';

            // Clear related localStorage
            localStorage.removeItem('businessName');
            localStorage.removeItem('businessDetails');
            localStorage.removeItem('toneOfVoice');
            localStorage.removeItem('desiredLength');
            localStorage.removeItem('domain');

            alert('Configuration Area has been cleared!');
        }

        // Clear Links Area
        function clearLinks() {
            if (!confirm('Are you sure you want to clear the Links Area?')) return;

            const linksList = document.getElementById('linksList');
            linksList.innerHTML = '';
            document.getElementById('extractButton').style.display = 'none';
            document.getElementById('selectAllButton').style.display = 'none';
            document.getElementById('clearLinksButton').style.display = 'none';

            // Clear related localStorage
            localStorage.removeItem('linksList');
            localStorage.removeItem('linksContent');

            // Update final prompt if necessary
            mainPromptContent = '';
            linksContent = '';
            updateMainPromptContent();

            alert('Links Area has been cleared!');
        }

        // Clear Final Prompt Text Area
        function clearFinalPrompt() {
            if (!confirm('Are you sure you want to clear the Final Prompt?')) return;

            document.getElementById('finalPromptText').value = '';
            mainPromptContent = '';
            linksContent = '';
            linksIncluded = false;
            document.getElementById('toggleLinks').checked = false;

            // Clear related localStorage
            localStorage.removeItem('finalPromptText');
            localStorage.removeItem('mainPromptContent');
            localStorage.removeItem('linksContent');
            localStorage.setItem('linksIncluded', false);

            alert('Final Prompt has been cleared!');
        }

        // Clear System Prompt in Playground
        function clearSystemPrompt() {
            if (!confirm('Are you sure you want to clear the System Prompt?')) return;

            document.getElementById('systemPrompt').value = '';

            // Clear related localStorage
            localStorage.removeItem('systemPrompt');

            alert('System Prompt has been cleared!');
        }

        // Save Configuration to localStorage on input change
        document.getElementById('businessName').addEventListener('input', () => {
            localStorage.setItem('businessName', document.getElementById('businessName').value);
        });

        document.getElementById('businessDetails').addEventListener('input', () => {
            localStorage.setItem('businessDetails', document.getElementById('businessDetails').value);
        });

        document.getElementById('toneOfVoice').addEventListener('input', () => {
            localStorage.setItem('toneOfVoice', document.getElementById('toneOfVoice').value);
        });

        document.getElementById('desiredLength').addEventListener('input', () => {
            localStorage.setItem('desiredLength', document.getElementById('desiredLength').value);
        });

        document.getElementById('domain').addEventListener('input', () => {
            localStorage.setItem('domain', document.getElementById('domain').value);
        });

        document.getElementById('systemPrompt').addEventListener('input', () => {
            localStorage.setItem('systemPrompt', document.getElementById('systemPrompt').value);
        });

        // Load Configuration from localStorage
        function loadConfiguration() {
            const businessName = localStorage.getItem('businessName') || '';
            const businessDetails = localStorage.getItem('businessDetails') || '';
            const toneOfVoice = localStorage.getItem('toneOfVoice') || '';
            const desiredLength = localStorage.getItem('desiredLength') || '';
            const domain = localStorage.getItem('domain') || '';

            document.getElementById('businessName').value = businessName;
            document.getElementById('businessDetails').value = businessDetails;
            document.getElementById('toneOfVoice').value = toneOfVoice;
            document.getElementById('desiredLength').value = desiredLength;
            document.getElementById('domain').value = domain;

            // Load system prompt
            const systemPrompt = localStorage.getItem('systemPrompt') || '';
            document.getElementById('systemPrompt').value = systemPrompt;
        }

        // Load playground conversation from localStorage
        function loadPlaygroundConversation() {
            const savedConversation = JSON.parse(localStorage.getItem('conversationHistory')) || [];
            const conversation = document.getElementById('conversation');

            savedConversation.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = msg.role === 'user' ? 'user-message' : (msg.role === 'assistant' ? 'bot-message' : 'bot-message error');
                msgDiv.textContent = msg.content;
                conversation.appendChild(msgDiv);
            });

            conversation.scrollTop = conversation.scrollHeight;
        }

        // Clear Chat Functionality
        function clearChat() {
            if (!confirm('Are you sure you want to clear the chat?')) return;

            const conversation = document.getElementById('conversation');
            conversation.innerHTML = '';
            conversationHistory = [];
            localStorage.removeItem('conversationHistory');
            alert('Chat has been cleared!');
        }

        // Playground Functionality
        let conversationHistory = JSON.parse(localStorage.getItem('conversationHistory')) || [];

        async function sendUserMessage() {
            const userInput = document.getElementById('userInput');
            const userMessage = userInput.value.trim();
            if (!userMessage) return;

            // Display user message
            const conversation = document.getElementById('conversation');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-message';
            userDiv.textContent = userMessage;
            conversation.appendChild(userDiv);
            conversation.scrollTop = conversation.scrollHeight;

            // Prepare conversation history
            conversationHistory.push({ role: "user", content: userMessage });
            localStorage.setItem('conversationHistory', JSON.stringify(conversationHistory));

            // Clear user input
            userInput.value = '';

            // Prepare API call
            const systemPrompt = document.getElementById('systemPrompt').value;
            const temperature = parseFloat(document.getElementById('temperature').value);
            const maxTokens = parseInt(document.getElementById('maxTokens').value);

            const messages = [
                { role: "system", content: systemPrompt },
                ...conversationHistory
            ];

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openAiApiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini", // Correct OpenAI model name
                        messages: messages,
                        max_tokens: maxTokens,
                        temperature: temperature,
                        stream: false // Changed to false for simplicity; streaming requires more complex handling
                    })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Unauthorized: Please check your OpenAI API key.');
                    } else {
                        throw new Error(`Failed to fetch response. Status: ${response.status}`);
                    }
                }

                const result = await response.json();
                const botMessage = result.choices[0].message.content.trim();

                // Display bot message with streaming animation
                appendBotMessageStream(botMessage);
            } catch (error) {
                console.error('Error:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bot-message error';
                errorDiv.textContent = `Error: ${error.message}`;
                conversation.appendChild(errorDiv);
                conversation.scrollTop = conversation.scrollHeight;
            }
        }

        // Function to append bot message with streaming effect
        function appendBotMessageStream(message) {
            const conversation = document.getElementById('conversation');

            // Create bot message div with typing indicator
            const botDiv = document.createElement('div');
            botDiv.className = 'bot-message';
            botDiv.innerHTML = '<div class="typing-indicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
            conversation.appendChild(botDiv);
            conversation.scrollTop = conversation.scrollHeight;

            let index = 0;
            const typingSpeed = 30; // milliseconds per character

            // Remove typing indicator and start appending text
            const typingIndicator = botDiv.querySelector('.typing-indicator');
            const appendInterval = setInterval(() => {
                if (index < message.length) {
                    botDiv.textContent += message.charAt(index);
                    index++;
                    conversation.scrollTop = conversation.scrollHeight;
                } else {
                    clearInterval(appendInterval);
                }
            }, typingSpeed);
        }

        // Setup Playground Event Listeners
        function setupPlaygroundEventListeners() {
            const sendMessage = document.getElementById('sendMessage');
            const userInput = document.getElementById('userInput');

            sendMessage.addEventListener('click', sendUserMessage);

            // Allow sending message with Enter key
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendUserMessage();
                }
            });
        }
    </script>
</body>
</html>
